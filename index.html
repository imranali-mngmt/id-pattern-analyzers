<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations - Enterprise Real-Time</title>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <style>
    :root {
      --bg-app: #f8fafc;
      --bg-panel: #ffffff;
      --bg-hover: #f1f5f9;
      --text-main: #1e293b;
      --text-label: #64748b;
      --btn-color: #3b82f6;
      --btn-hover: #2563eb;
      --border-color: #e2e8f0;
      --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --online-color: #10b981;
    }

    * {
      box-sizing: border-box;
      outline: none;
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-stack);
      background: var(--bg-app);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: var(--bg-panel);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .brand {
      font-weight: 800;
      font-size: 18px;
      color: #3b82f6;
      letter-spacing: -0.5px;
    }

    .nav-tabs {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-tab {
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-label);
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
      user-select: none;
    }

    .nav-tab:hover {
      background: var(--bg-hover);
    }

    .nav-tab.active {
      background: #3b82f6;
      color: white;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-badge {
      font-size: 12px;
      font-weight: 600;
      color: #10b981;
      padding: 4px 8px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-badge.admin {
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .logout-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-label);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: var(--bg-hover);
      color: var(--text-main);
      border-color: #3b82f6;
    }

    .container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 30px 20px;
    }

    .page {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
    }

    .processor-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 350px;
      width: 100%;
    }

    .input-card {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 35px;
      width: 100%;
      max-width: 550px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .input-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
    }

    .input-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-label);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 12px;
    }

    .input-hint {
      font-size: 11px;
      color: var(--text-label);
      margin-bottom: 14px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      background: var(--bg-app);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 14px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: vertical;
      color: var(--text-main);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }

    textarea::placeholder {
      color: #cbd5e1;
    }

    textarea:focus {
      border-color: #3b82f6;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04), 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-execute {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      margin-top: 18px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-execute:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-execute:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-panel);
      border-radius: 10px;
      padding: 35px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: slideUp 0.3s ease-out;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 14px;
      right: 14px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-label);
      transition: color 0.2s;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--text-main);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-main);
      margin: 0 0 20px 0;
      text-align: center;
    }

    .modal-result-box {
      background: var(--bg-app);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 18px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      color: #059669;
      line-height: 1.7;
      word-break: break-all;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .modal-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 18px;
    }

    .stat-item {
      background: var(--bg-app);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-item-value {
      font-size: 24px;
      font-weight: 800;
      color: #3b82f6;
    }

    .stat-item-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-label);
      text-transform: uppercase;
      margin-top: 6px;
    }

    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn-copy {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s;
    }

    .btn-copy:hover {
      background: #2563eb;
    }

    .btn-close {
      background: transparent;
      color: var(--text-label);
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s;
    }

    .btn-close:hover {
      background: var(--bg-hover);
      border-color: #3b82f6;
    }

    .admin-panel-wrapper {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .admin-panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 35px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .admin-section {
      margin-bottom: 30px;
    }

    .admin-section:last-child {
      margin-bottom: 0;
    }

    .admin-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .refresh-indicator {
      font-size: 12px;
      color: #10b981;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .refresh-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
      width: 100%;
    }

    .analytics-card {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .analytics-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .analytics-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
    }

    .analytics-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-label);
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }

    .analytics-value {
      font-size: 32px;
      font-weight: 800;
      color: #3b82f6;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .analytics-subtext {
      font-size: 11px;
      color: var(--text-label);
    }

    .analytics-card.success .analytics-value {
      color: #10b981;
    }

    .analytics-card.success::before {
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .analytics-card.warning .analytics-value {
      color: #f59e0b;
    }

    .analytics-card.warning::before {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .analytics-card.error .analytics-value {
      color: #ef4444;
    }

    .analytics-card.error::before {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .user-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .user-item {
      background: var(--bg-app);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }

    .user-item:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.02);
    }

    .user-item-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .user-item-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-main);
      font-family: 'Consolas', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-online-dot {
      width: 10px;
      height: 10px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .user-item-status {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-label);
    }

    .user-item-status.granted {
      color: #10b981;
    }

    .user-item-status.denied {
      color: #ef4444;
    }

    .user-item-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn-grant {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-grant:hover {
      background: #059669;
    }

    .btn-revoke {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-revoke:hover {
      background: #dc2626;
    }

    .add-user-group {
      display: flex;
      gap: 10px;
    }

    .add-user-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: 'Consolas', monospace;
    }

    .add-user-input::placeholder {
      color: #cbd5e1;
    }

    .add-user-input:focus {
      border-color: #3b82f6;
    }

    .btn-add-user {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-add-user:hover {
      background: #2563eb;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .history-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-main);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      width: 100%;
    }

    .stat-card {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-label);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #3b82f6;
    }

    .history-tools {
      background: var(--bg-panel);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .tool-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 150px;
    }

    .tool-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-label);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .tool-input {
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg-app);
      color: var(--text-main);
      transition: all 0.2s;
    }

    .tool-input::placeholder {
      color: #cbd5e1;
    }

    .tool-input:focus {
      border-color: #3b82f6;
    }

    .table-wrapper {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 12px 14px;
      background: var(--bg-app);
      color: var(--text-label);
      font-size: 11px;
      font-weight: 700;
      border-bottom: 1px solid var(--border-color);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-color);
      font-family: 'Consolas', monospace;
      font-size: 12px;
      color: var(--text-main);
    }

    tr:hover {
      background: var(--bg-hover);
    }

    .copy-all-btn {
      width: 100%;
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s;
    }

    .copy-all-btn:hover {
      background: #2563eb;
    }

    #view-login {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-box {
      background: var(--bg-panel);
      padding: 35px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      width: 340px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: slideUp 0.3s ease-out;
    }

    .login-box h3 {
      margin: 0 0 6px 0;
      color: #3b82f6;
      font-size: 22px;
      font-weight: 800;
    }

    .login-box p {
      font-size: 12px;
      color: var(--text-label);
      margin: 0 0 25px 0;
    }

    .login-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      text-align: center;
      margin-bottom: 10px;
      background: var(--bg-app);
      color: var(--text-main);
      transition: all 0.2s;
      font-family: 'Consolas', monospace;
      font-weight: 500;
    }

    .login-input::placeholder {
      color: #cbd5e1;
    }

    .login-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .login-preview {
      font-size: 11px;
      color: #10b981;
      margin-bottom: 14px;
      padding: 8px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 6px;
      border-left: 2px solid #10b981;
      display: none;
    }

    .login-preview.show {
      display: block;
    }

    #loginError {
      color: #ef4444;
      font-size: 11px;
      margin-top: 10px;
      display: none;
      padding: 8px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 6px;
      border-left: 2px solid #ef4444;
    }

    #loginError.show {
      display: block;
    }

    .error-banner {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #b91c1c;
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 18px;
      font-size: 12px;
      display: none;
      width: 100%;
      max-width: 1200px;
      border-left: 2px solid #ef4444;
    }

    .error-banner.show {
      display: block;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(59, 130, 246, 0.2);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .active-users-widget {
      background: var(--bg-app);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }

    .active-users-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .active-user-badge {
      font-size: 11px;
      font-weight: 600;
      color: white;
      background: #10b981;
      padding: 4px 10px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .active-user-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    /* Access Revoked Overlay */
    .access-revoked-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .access-revoked-overlay.show {
      display: flex;
    }

    .access-revoked-box {
      background: var(--bg-panel);
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .access-revoked-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .access-revoked-title {
      font-size: 20px;
      font-weight: 800;
      color: #ef4444;
      margin-bottom: 12px;
    }

    .access-revoked-text {
      font-size: 13px;
      color: var(--text-label);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    @media (max-width: 768px) {
      .header {
        padding: 0 20px;
      }

      .container {
        padding: 20px 15px;
      }

      .input-card, .admin-panel {
        padding: 25px;
      }

      textarea {
        min-height: 150px;
      }

      .modal-content {
        padding: 25px;
      }

      .login-box {
        width: 85%;
        padding: 25px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      .analytics-grid {
        grid-template-columns: 1fr;
      }

      .history-tools {
        flex-direction: column;
      }

      .tool-group {
        width: 100%;
      }

      .user-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .user-item-actions {
        width: 100%;
        margin-top: 10px;
      }

      .user-item-actions button {
        flex: 1;
      }
    }
  </style>
</head>

<body>

  <!-- ACCESS REVOKED OVERLAY -->
  <div id="accessRevokedOverlay" class="access-revoked-overlay">
    <div class="access-revoked-box">
      <div class="access-revoked-icon">üö´</div>
      <div class="access-revoked-title">Access Revoked</div>
      <div class="access-revoked-text">Your access has been revoked by an administrator. Please contact support for assistance.</div>
      <button class="btn-execute" onclick="AuthManager.forceLogout()">Return to Login</button>
    </div>
  </div>

  <!-- LOGIN VIEW -->
  <div id="view-login">
    <div class="login-box">
      <h3>MindA_ID</h3>
      <input type="text" id="loginId" class="login-input" placeholder="MindA ID (e.g minda077)" spellcheck="false">
      <div id="loginPreview" class="login-preview"></div>
      <button class="btn-execute" onclick="AuthManager.login()">Login</button>
      <div id="loginError"></div>
    </div>
  </div>

  <!-- ADMIN AUTH MODAL -->
  <div id="adminAuthModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" onclick="AuthManager.closeAdminAuth()">&times;</button>
      <h2 class="modal-title">Admin Verification</h2>
      <div class="input-label" style="margin-bottom: 16px; text-align: center;">Enter your password</div>
      <input type="password" id="adminPassword" class="login-input" placeholder="Enter password" spellcheck="false">
      <div id="adminError" style="color: #ef4444; font-size: 11px; margin-top: 10px; display: none;"></div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px;">
        <button class="btn-copy" onclick="AuthManager.verifyAdmin()">Verify</button>
        <button class="btn-close" onclick="AuthManager.closeAdminAuth()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="view-app" style="display:none; height:100vh; flex-direction:column;">

    <div class="header">
      <div class="brand">üìä Enterprise Analytics</div>
      <div class="nav-tabs">
        <div class="nav-tab active" onclick="NavigationManager.goTo('processor', this)">Processor</div>
        <div id="historyNavTab" class="nav-tab" style="display:none;" onclick="NavigationManager.goTo('history', this)">History</div>
        <div id="adminNavTab" class="nav-tab" style="display:none;" onclick="NavigationManager.goTo('admin', this)">Admin</div>
      </div>
      <div class="user-section">
        <div class="user-badge" id="userBadge">
          <span class="status-dot"></span>
          <span id="userBadgeText"></span>
        </div>
        <button class="logout-btn" onclick="AuthManager.logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <div id="errorBanner" class="error-banner"></div>

      <!-- PROCESSOR PAGE -->
      <div id="page-processor" class="page active">
        <div class="processor-wrapper">
          <div class="input-card">
            <div class="input-label">Input Stream</div>
            <div class="input-hint">Paste 11-digit IDs (comma, space, or newline separated)</div>
            <textarea id="inputData" placeholder="Paste your data here..." spellcheck="false"></textarea>
            <button id="executeBtn" class="btn-execute" onclick="ProcessorManager.execute()">EXECUTE</button>
          </div>
        </div>
      </div>

      <!-- RESULTS MODAL -->
      <div id="resultsModal" class="modal-overlay">
        <div class="modal-content">
          <button class="modal-close" onclick="UIManager.closeModal()">&times;</button>
          <h2 class="modal-title">Results</h2>
          
          <div class="modal-stats">
            <div class="stat-item">
              <div class="stat-item-value" id="modalFound">0</div>
              <div class="stat-item-label">Found</div>
            </div>
            <div class="stat-item">
              <div class="stat-item-value" id="modalSequential">0</div>
              <div class="stat-item-label">Sequential</div>
            </div>
          </div>

          <div class="modal-result-box" id="modalResultBox"></div>

          <div class="modal-actions">
            <button class="btn-copy" onclick="UIManager.copyFromModal()">Copy All</button>
            <button class="btn-close" onclick="UIManager.closeModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- ADMIN PANEL PAGE -->
      <div id="page-admin" class="page">
        <div class="admin-panel-wrapper">
          
          <!-- Real-time Analytics -->
          <div class="admin-panel">
            <div class="admin-section">
              <div class="admin-section-title">
                <span>üìä Real-Time Analytics</span>
                <span class="refresh-indicator">
                  <span class="refresh-dot"></span>Live
                </span>
              </div>
              <div class="analytics-grid">
                <div class="analytics-card success">
                  <div class="analytics-label">Total Unique Users</div>
                  <div class="analytics-value" id="totalUsers">0</div>
                  <div class="analytics-subtext">All time</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-label">Active Right Now</div>
                  <div class="analytics-value" id="activeUsersNow">0</div>
                  <div class="analytics-subtext">Online</div>
                </div>
                <div class="analytics-card warning">
                  <div class="analytics-label">Granted Access</div>
                  <div class="analytics-value" id="grantedCount">0</div>
                  <div class="analytics-subtext">Users with access</div>
                </div>
                <div class="analytics-card error">
                  <div class="analytics-label">Pending Access</div>
                  <div class="analytics-value" id="deniedCount">0</div>
                  <div class="analytics-subtext">Awaiting approval</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-label">Total IDs Uploaded</div>
                  <div class="analytics-value" id="totalUploads">0</div>
                  <div class="analytics-subtext">Processed</div>
                </div>
                <div class="analytics-card success">
                  <div class="analytics-label">Sequential Found</div>
                  <div class="analytics-value" id="sequentialCount">0</div>
                  <div class="analytics-subtext">Detected</div>
                </div>
              </div>

              <!-- Active Users Widget -->
              <div class="active-users-widget">
                <div class="input-label">Active Users Right Now</div>
                <div class="active-users-list" id="activeUsersList">
                  <span style="font-size: 11px; color: var(--text-label);">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Access Control -->
          <div class="admin-panel">
            <div class="admin-section">
              <div class="admin-section-title">
                <span>üîê Access Control</span>
                <span class="refresh-indicator">
                  <span class="refresh-dot"></span>Live
                </span>
              </div>
              <div class="user-list" id="accessList"></div>
              <div class="add-user-group" style="margin-top: 15px;">
                <input type="text" id="newUserInput" class="add-user-input" placeholder="e.g., minda001" spellcheck="false">
                <button class="btn-add-user" onclick="AdminManager.addUser()">Add User</button>
              </div>
            </div>
          </div>

          <!-- System Info -->
          <div class="admin-panel">
            <div class="admin-section">
              <div class="admin-section-title">üìã System Status</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div style="background: var(--bg-app); padding: 12px; border-radius: 8px;">
                  <div class="input-label">Database Status</div>
                  <div style="font-size: 14px; font-weight: 700; color: #10b981; margin-top: 6px;">‚úì Connected</div>
                </div>
                <div style="background: var(--bg-app); padding: 12px; border-radius: 8px;">
                  <div class="input-label">Real-Time Updates</div>
                  <div style="font-size: 14px; font-weight: 700; color: #10b981; margin-top: 6px;">‚úì Active</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- HISTORY PAGE -->
      <div id="page-history" class="page">
        <div class="history-header">
          <div class="history-title">üìà Search & Analyze</div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Your Records</div>
            <div class="stat-value" id="statYourRecords">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Shared with You</div>
            <div class="stat-value" id="statSharedRecords">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Access</div>
            <div class="stat-value" id="statTotalAccess">0</div>
          </div>
        </div>

        <!-- Search Tools -->
        <div class="history-tools">
          <div class="tool-group">
            <span class="tool-label">Filter Date</span>
            <input type="date" id="filterDate" class="tool-input">
          </div>
          <div class="tool-group">
            <span class="tool-label">Search ID or User</span>
            <input type="text" id="filterId" class="tool-input" placeholder="11-digit ID or user">
          </div>
          <div class="tool-group">
            <span class="tool-label">View Mode</span>
            <select id="viewMode" class="tool-input" onchange="HistoryManager.fetch()">
              <option value="my">My Records</option>
              <option value="shared">Shared with Me</option>
              <option value="all">All Access</option>
            </select>
          </div>
          <button class="btn-execute" style="width: auto; padding: 8px 18px; font-size: 11px;" 
            onclick="HistoryManager.fetch()">Search</button>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
          <table id="historyTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Owner</th>
                <th>Time</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    'use strict';

    // CONFIG
    const CONFIG = {
      FIREBASE: {
        apiKey: "AIzaSyAAM8jlY-zKAsTNu3BKmrLtz0rb_fG-P24",
        authDomain: "imranali-mngmt-e464f.firebaseapp.com",
        projectId: "imranali-mngmt-e464f",
        storageBucket: "imranali-mngmt-e464f.firebasestorage.app",
        messagingSenderId: "1030605656898",
        appId: "1:1030605656898:web:3825d797b521c9c90a2edb"
      },
      ADMIN_USER: 'MINDA077',
      ADMIN_PASSWORD: 'imran077',
      SESSION_KEY: 'minda_session',
      REGEX: {
        ID_PATTERN: /\b\d{11}\b/g,
        ID_VALIDATE: /^\d{11}$/,
        MINDA_ID: /^minda\d{3}$/i
      }
    };

    // SESSION MANAGER - Handles persistence across page refreshes
    const SessionManager = {
      save: (userId, isAdmin) => {
        const sessionData = {
          userId,
          isAdmin,
          timestamp: Date.now()
        };
        localStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify(sessionData));
      },

      get: () => {
        try {
          const data = localStorage.getItem(CONFIG.SESSION_KEY);
          if (!data) return null;
          
          const session = JSON.parse(data);
          // Session expires after 24 hours
          if (Date.now() - session.timestamp > 24 * 60 * 60 * 1000) {
            SessionManager.clear();
            return null;
          }
          return session;
        } catch (e) {
          return null;
        }
      },

      clear: () => {
        localStorage.removeItem(CONFIG.SESSION_KEY);
      },

      exists: () => {
        return SessionManager.get() !== null;
      }
    };

    // FIREBASE MANAGER
    const FirebaseManager = (() => {
      let db = null;

      return {
        init: async () => {
          try {
            if (!firebase.apps.length) {
              firebase.initializeApp(CONFIG.FIREBASE);
            }
            db = firebase.firestore();
            
            // Initialize admin documents if they don't exist
            await FirebaseManager.initializeAdminDocs();
            
            return { success: true };
          } catch (error) {
            console.error('Firebase init error:', error);
            return { success: false };
          }
        },

        getDb: () => db,

        initializeAdminDocs: async () => {
          try {
            // Initialize access_control document
            const accessDoc = await db.collection('admin').doc('access_control').get();
            if (!accessDoc.exists) {
              await db.collection('admin').doc('access_control').set({
                granted: [CONFIG.ADMIN_USER],
                denied: []
              });
            }

            // Initialize analytics document
            const analyticsDoc = await db.collection('admin').doc('analytics').get();
            if (!analyticsDoc.exists) {
              await db.collection('admin').doc('analytics').set({
                total_users: 0,
                total_uploads: 0,
                sequential_count: 0
              });
            }

            // Initialize activity document
            const activityDoc = await db.collection('admin').doc('activity').get();
            if (!activityDoc.exists) {
              await db.collection('admin').doc('activity').set({
                active_users: {}
              });
            }
          } catch (error) {
            console.error('Init admin docs error:', error);
          }
        },

        uploadBatch: async (userId, ids, batchDate) => {
          try {
            const batch = db.batch();
            const userRef = db.collection('users').doc(userId);

            for (const id of ids) {
              if (!/^\d{11}$/.test(id)) continue;
              const ref = userRef.collection('records').doc(id);
              batch.set(ref, {
                id,
                uploaded_by: userId,
                uploaded_at: firebase.firestore.FieldValue.serverTimestamp(),
                batch_date: batchDate,
                is_sequential: true
              }, { merge: true });
            }

            await batch.commit();

            // Update analytics
            await db.collection('admin').doc('analytics').set({
              total_uploads: firebase.firestore.FieldValue.increment(ids.length),
              sequential_count: firebase.firestore.FieldValue.increment(ids.length),
              last_upload: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            return { success: true, count: ids.length };
          } catch (error) {
            console.error('Upload error:', error);
            return { success: false };
          }
        },

        getAccessControl: async () => {
          try {
            const doc = await db.collection('admin').doc('access_control').get();
            return doc.exists ? doc.data() : { granted: [CONFIG.ADMIN_USER], denied: [] };
          } catch (error) {
            return { granted: [CONFIG.ADMIN_USER], denied: [] };
          }
        },

        saveAccessControl: async (access) => {
          try {
            await db.collection('admin').doc('access_control').set(access);
            return true;
          } catch (error) {
            console.error('Save access error:', error);
            return false;
          }
        },

        updateUserActivity: async (userId, isOnline) => {
          try {
            if (isOnline) {
              await db.collection('admin').doc('activity').set({
                [`active_users.${userId}`]: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge: true });
            } else {
              await db.collection('admin').doc('activity').update({
                [`active_users.${userId}`]: firebase.firestore.FieldValue.delete()
              });
            }
          } catch (error) {
            console.error('Activity update error:', error);
          }
        },

        registerUser: async (userId) => {
          try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
              await db.collection('users').doc(userId).set({
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                user_id: userId
              });
              
              // Update total users count
              await db.collection('admin').doc('analytics').set({
                total_users: firebase.firestore.FieldValue.increment(1)
              }, { merge: true });
            }
          } catch (error) {
            console.error('Register user error:', error);
          }
        },

        getRecordsForUser: async (userId, accessControl) => {
          try {
            const userRef = db.collection('users').doc(userId);
            const snap = await userRef.collection('records').limit(100).get();
            const records = snap.docs.map(d => ({ ...d.data(), owner: userId }));

            // Get shared records
            if (accessControl.granted.includes(userId)) {
              for (const owner of accessControl.granted) {
                if (owner === userId) continue;
                try {
                  const sharedRef = db.collection('users').doc(owner);
                  const sharedSnap = await sharedRef.collection('records').limit(50).get();
                  sharedSnap.docs.forEach(d => records.push({ ...d.data(), owner, shared: true }));
                } catch (e) {}
              }
            }

            return records;
          } catch (error) {
            console.error('Get records error:', error);
            return [];
          }
        },

        // Real-time listeners
        listenToAnalytics: (callback) => {
          try {
            return db.collection('admin').doc('analytics')
              .onSnapshot((doc) => {
                const data = doc.exists ? doc.data() : {};
                callback(data);
              }, (error) => {
                console.error('Analytics listener error:', error);
              });
          } catch (error) {
            console.error('Analytics listener setup error:', error);
            return null;
          }
        },

        listenToAccessControl: (callback) => {
          try {
            return db.collection('admin').doc('access_control')
              .onSnapshot((doc) => {
                const data = doc.exists ? doc.data() : { granted: [], denied: [] };
                callback(data);
              }, (error) => {
                console.error('Access control listener error:', error);
              });
          } catch (error) {
            console.error('Access control listener setup error:', error);
            return null;
          }
        },

        listenToActiveUsers: (callback) => {
          try {
            return db.collection('admin').doc('activity')
              .onSnapshot((doc) => {
                const data = doc.exists ? doc.data() : { active_users: {} };
                callback(data.active_users || {});
              }, (error) => {
                console.error('Active users listener error:', error);
              });
          } catch (error) {
            console.error('Active users listener setup error:', error);
            return null;
          }
        }
      };
    })();

    // EXCEPTION HANDLER
    const ExceptionHandler = {
      toast: (message, type = 'error') => {
        const colors = {
          error: '#ef4444',
          warning: '#f59e0b',
          success: '#10b981',
          info: '#3b82f6'
        };

        if (typeof Toastify !== 'undefined') {
          Toastify({
            text: message,
            duration: 2500,
            style: {
              background: colors[type] || colors.error,
              borderRadius: "6px",
              fontSize: "12px",
              fontWeight: "600"
            }
          }).showToast();
        }
      }
    };

    // AUTH MANAGER
    const AuthManager = (() => {
      let currentUser = null;
      let isAdmin = false;

      return {
        login: async () => {
          try {
            const idInput = document.getElementById('loginId');
            const id = idInput?.value?.trim();

            if (!id) throw new Error('Enter your MindA ID');

            const formatted = id.toUpperCase().replace(/\s/g, '');
            if (!/^MINDA\d{3}$/.test(formatted) && !/^\d{3}$/.test(formatted)) {
              throw new Error('Invalid format. Use: minda001 or 001');
            }

            const fullId = formatted.startsWith('MINDA') ? formatted : `MINDA${formatted}`;
            
            // Check if user has access (non-admin users)
            if (fullId !== CONFIG.ADMIN_USER) {
              const access = await FirebaseManager.getAccessControl();
              if (!access.granted.includes(fullId)) {
                if (!access.denied.includes(fullId)) {
                  // Add new user to denied list (pending approval)
                  access.denied.push(fullId);
                  await FirebaseManager.saveAccessControl(access);
                }
                throw new Error('Access pending admin approval');
              }
            }

            currentUser = fullId;
            isAdmin = fullId === CONFIG.ADMIN_USER;

            if (isAdmin) {
              document.getElementById('adminAuthModal').classList.add('show');
              return;
            }

            AuthManager.completeLogin();
          } catch (error) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
              errorDiv.textContent = error.message;
              errorDiv.classList.add('show');
            }
          }
        },

        verifyAdmin: async () => {
          try {
            const passwordInput = document.getElementById('adminPassword');
            const password = passwordInput?.value?.trim();

            if (!password) throw new Error('Enter password');
            if (password !== CONFIG.ADMIN_PASSWORD) {
              throw new Error('Incorrect password');
            }

            document.getElementById('adminAuthModal').classList.remove('show');
            AuthManager.completeLogin();
          } catch (error) {
            const errorDiv = document.getElementById('adminError');
            if (errorDiv) {
              errorDiv.textContent = error.message;
              errorDiv.style.display = 'block';
            }
          }
        },

        closeAdminAuth: () => {
          document.getElementById('adminAuthModal').classList.remove('show');
          document.getElementById('adminPassword').value = '';
          document.getElementById('adminError').style.display = 'none';
          currentUser = null;
          isAdmin = false;
        },

        completeLogin: async () => {
          try {
            // Save session for persistence
            SessionManager.save(currentUser, isAdmin);

            // Register user and set activity
            await FirebaseManager.registerUser(currentUser);
            await FirebaseManager.updateUserActivity(currentUser, true);

            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-app').style.display = 'flex';

            const badge = document.getElementById('userBadgeText');
            badge.textContent = currentUser + (isAdmin ? ' (Admin)' : '');

            if (isAdmin) {
              document.getElementById('userBadge').classList.add('admin');
              document.getElementById('historyNavTab').style.display = 'block';
              document.getElementById('adminNavTab').style.display = 'block';
              RealtimeManager.startAdminListeners();
            } else {
              document.getElementById('userBadge').classList.remove('admin');
              document.getElementById('adminNavTab').style.display = 'none';
              document.getElementById('historyNavTab').style.display = 'block';
              RealtimeManager.startUserListeners();
            }

            document.getElementById('loginId').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').classList.remove('show');
          } catch (error) {
            ExceptionHandler.toast('Login failed', 'error');
          }
        },

        restoreSession: async () => {
          const session = SessionManager.get();
          if (!session) return false;

          try {
            currentUser = session.userId;
            isAdmin = session.isAdmin;

            // Verify access is still valid for non-admin users
            if (!isAdmin) {
              const access = await FirebaseManager.getAccessControl();
              if (!access.granted.includes(currentUser)) {
                SessionManager.clear();
                currentUser = null;
                isAdmin = false;
                return false;
              }
            }

            // Restore the session
            await FirebaseManager.updateUserActivity(currentUser, true);

            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-app').style.display = 'flex';

            const badge = document.getElementById('userBadgeText');
            badge.textContent = currentUser + (isAdmin ? ' (Admin)' : '');

            if (isAdmin) {
              document.getElementById('userBadge').classList.add('admin');
              document.getElementById('historyNavTab').style.display = 'block';
              document.getElementById('adminNavTab').style.display = 'block';
              RealtimeManager.startAdminListeners();
            } else {
              document.getElementById('userBadge').classList.remove('admin');
              document.getElementById('adminNavTab').style.display = 'none';
              document.getElementById('historyNavTab').style.display = 'block';
              RealtimeManager.startUserListeners();
            }

            return true;
          } catch (error) {
            console.error('Session restore error:', error);
            SessionManager.clear();
            return false;
          }
        },

        logout: () => {
          if (confirm('Logout?')) {
            FirebaseManager.updateUserActivity(currentUser, false);
            SessionManager.clear();
            RealtimeManager.stopAll();
            currentUser = null;
            isAdmin = false;
            document.getElementById('view-app').style.display = 'none';
            document.getElementById('view-login').style.display = 'flex';
            document.getElementById('accessRevokedOverlay').classList.remove('show');
          }
        },

        forceLogout: () => {
          FirebaseManager.updateUserActivity(currentUser, false);
          SessionManager.clear();
          RealtimeManager.stopAll();
          currentUser = null;
          isAdmin = false;
          document.getElementById('view-app').style.display = 'none';
          document.getElementById('view-login').style.display = 'flex';
          document.getElementById('accessRevokedOverlay').classList.remove('show');
        },

        handleAccessRevoked: () => {
          document.getElementById('accessRevokedOverlay').classList.add('show');
        },

        getUser: () => currentUser,
        isAdmin: () => isAdmin
      };
    })();

    // REAL-TIME MANAGER
    const RealtimeManager = (() => {
      let unsubscribers = [];
      let accessControlCache = null;

      return {
        startAdminListeners: () => {
          // Analytics listener
          const analyticsSub = FirebaseManager.listenToAnalytics((data) => {
            document.getElementById('totalUsers').textContent = data.total_users || 0;
            document.getElementById('totalUploads').textContent = data.total_uploads || 0;
            document.getElementById('sequentialCount').textContent = data.sequential_count || 0;
          });
          if (analyticsSub) unsubscribers.push(analyticsSub);

          // Access control listener
          const accessSub = FirebaseManager.listenToAccessControl((data) => {
            accessControlCache = data;
            document.getElementById('grantedCount').textContent = data.granted?.length || 0;
            document.getElementById('deniedCount').textContent = data.denied?.length || 0;
            AdminManager.renderAccessList(data);
          });
          if (accessSub) unsubscribers.push(accessSub);

          // Active users listener
          const activeSub = FirebaseManager.listenToActiveUsers((users) => {
            const activeCount = Object.keys(users).filter(u => users[u]).length;
            document.getElementById('activeUsersNow').textContent = activeCount;
            RealtimeManager.updateActiveUsersList(users);
          });
          if (activeSub) unsubscribers.push(activeSub);
        },

        startUserListeners: () => {
          // Access control listener - to detect when access is revoked
          const accessSub = FirebaseManager.listenToAccessControl((data) => {
            accessControlCache = data;
            const currentUser = AuthManager.getUser();
            
            // Check if user's access was revoked
            if (currentUser && currentUser !== CONFIG.ADMIN_USER) {
              if (!data.granted.includes(currentUser)) {
                // Access has been revoked
                AuthManager.handleAccessRevoked();
              }
            }
          });
          if (accessSub) unsubscribers.push(accessSub);

          // Active users listener
          const activeSub = FirebaseManager.listenToActiveUsers((users) => {
            // User can see who's online if needed
          });
          if (activeSub) unsubscribers.push(activeSub);
        },

        updateActiveUsersList: (users) => {
          const list = document.getElementById('activeUsersList');
          if (!list) return;

          const activeUsers = Object.keys(users).filter(u => users[u]);
          if (activeUsers.length === 0) {
            list.innerHTML = '<span style="font-size: 11px; color: var(--text-label);">No users online</span>';
            return;
          }

          list.innerHTML = activeUsers.map(user => 
            `<div class="active-user-badge">
              <span class="active-user-dot"></span>
              ${user}
            </div>`
          ).join('');
        },

        getAccessControlCache: () => accessControlCache,

        stopAll: () => {
          unsubscribers.forEach(unsub => {
            try {
              if (typeof unsub === 'function') unsub();
            } catch (e) {}
          });
          unsubscribers = [];
        }
      };
    })();

    // ADMIN MANAGER
    const AdminManager = {
      renderAccessList: (access) => {
        const list = document.getElementById('accessList');
        if (!list) return;

        let html = '';
        
        if (access.granted.length === 0 && access.denied.length === 0) {
          list.innerHTML = '<div style="color: var(--text-label); text-align: center; padding: 20px;">No users yet</div>';
          return;
        }

        // Render granted users (except admin)
        access.granted.filter(u => u !== CONFIG.ADMIN_USER).forEach(user => {
          html += `<div class="user-item">
            <div class="user-item-info">
              <div class="user-item-name">${user}</div>
              <div class="user-item-status granted">‚úì Access Granted</div>
            </div>
            <div class="user-item-actions">
              <button class="btn-revoke" onclick="AdminManager.revokeAccess('${user}')">Revoke</button>
            </div>
          </div>`;
        });

        // Render denied users
        access.denied.forEach(user => {
          html += `<div class="user-item">
            <div class="user-item-info">
              <div class="user-item-name">${user}</div>
              <div class="user-item-status denied">‚úó Access Denied</div>
            </div>
            <div class="user-item-actions">
              <button class="btn-grant" onclick="AdminManager.grantAccess('${user}')">Grant</button>
              <button class="btn-revoke" onclick="AdminManager.removeUser('${user}')">Remove</button>
            </div>
          </div>`;
        });

        list.innerHTML = html || '<div style="color: var(--text-label); text-align: center; padding: 20px;">No users to manage</div>';
      },

      addUser: async () => {
        const input = document.getElementById('newUserInput');
        const userInput = input?.value?.trim();

        if (!userInput) {
          ExceptionHandler.toast('Enter a MindA ID', 'warning');
          return;
        }

        const formatted = userInput.toUpperCase();
        const fullId = formatted.startsWith('MINDA') ? formatted : `MINDA${formatted}`;

        if (!/^MINDA\d{3}$/.test(fullId)) {
          ExceptionHandler.toast('Invalid format (use: minda001 or 001)', 'error');
          return;
        }

        if (fullId === CONFIG.ADMIN_USER) {
          ExceptionHandler.toast('Cannot manage admin', 'warning');
          return;
        }

        try {
          const access = await FirebaseManager.getAccessControl();
          if (access.granted.includes(fullId) || access.denied.includes(fullId)) {
            ExceptionHandler.toast('User already exists', 'warning');
            return;
          }

          access.denied.push(fullId);
          await FirebaseManager.saveAccessControl(access);
          input.value = '';
          ExceptionHandler.toast(`Added ${fullId}`, 'success');
        } catch (error) {
          ExceptionHandler.toast('Failed to add user', 'error');
        }
      },

      grantAccess: async (userId) => {
        try {
          const access = await FirebaseManager.getAccessControl();
          const idx = access.denied.indexOf(userId);
          if (idx > -1) {
            access.denied.splice(idx, 1);
          }
          if (!access.granted.includes(userId)) {
            access.granted.push(userId);
          }
          await FirebaseManager.saveAccessControl(access);
          ExceptionHandler.toast(`Access granted to ${userId}`, 'success');
        } catch (error) {
          ExceptionHandler.toast('Failed to grant access', 'error');
        }
      },

      revokeAccess: async (userId) => {
        if (!confirm(`Revoke access for ${userId}? They will be logged out immediately.`)) return;
        
        try {
          const access = await FirebaseManager.getAccessControl();
          const idx = access.granted.indexOf(userId);
          if (idx > -1) {
            access.granted.splice(idx, 1);
          }
          if (!access.denied.includes(userId)) {
            access.denied.push(userId);
          }
          await FirebaseManager.saveAccessControl(access);
          
          // Remove from active users
          await FirebaseManager.updateUserActivity(userId, false);
          
          ExceptionHandler.toast(`Access revoked from ${userId}`, 'success');
        } catch (error) {
          ExceptionHandler.toast('Failed to revoke access', 'error');
        }
      },

      removeUser: async (userId) => {
        if (!confirm(`Completely remove ${userId}?`)) return;

        try {
          const access = await FirebaseManager.getAccessControl();
          access.granted = access.granted.filter(u => u !== userId);
          access.denied = access.denied.filter(u => u !== userId);
          await FirebaseManager.saveAccessControl(access);
          ExceptionHandler.toast(`Removed ${userId}`, 'success');
        } catch (error) {
          ExceptionHandler.toast('Failed to remove user', 'error');
        }
      }
    };

    // PROCESSOR MANAGER
    const ProcessorManager = {
      execute: async () => {
        const btn = document.getElementById('executeBtn');
        try {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span> Processing...';

          const user = AuthManager.getUser();
          const inputData = document.getElementById('inputData')?.value;

          if (!inputData?.trim()) throw new Error('Input empty');

          const matches = inputData.match(CONFIG.REGEX.ID_PATTERN);
          if (!matches?.length) throw new Error('No 11-digit IDs found');

          const uniqueIds = [...new Set(matches)];
          const bigIntIds = uniqueIds.map(id => ({ str: id, val: BigInt(id) }))
            .sort((a, b) => a.val < b.val ? -1 : 1);

          const sequential = [];
          for (let i = 0; i < bigIntIds.length; i++) {
            const curr = bigIntIds[i].val;
            let isSeq = false;

            if (i > 0 && curr === bigIntIds[i - 1].val + 1n) isSeq = true;
            if (i < bigIntIds.length - 1 && curr === bigIntIds[i + 1].val - 1n) isSeq = true;

            if (isSeq) sequential.push(bigIntIds[i].str);
          }

          if (sequential.length === 0) {
            ExceptionHandler.toast('No sequential IDs found', 'warning');
            return;
          }

          UIManager.showResultsModal(sequential, uniqueIds.length);
          document.getElementById('inputData').value = '';

          // Background upload
          const today = new Date().toISOString().split('T')[0];
          await FirebaseManager.uploadBatch(user, sequential, today);

          ExceptionHandler.toast(`Found ${sequential.length} sequential ID(s)`, 'success');
        } catch (error) {
          ExceptionHandler.toast(error.message || 'Processing failed', 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'EXECUTE';
        }
      }
    };

    // UI MANAGER
    const UIManager = {
      showResultsModal: (sequential, total) => {
        const modal = document.getElementById('resultsModal');
        document.getElementById('modalFound').textContent = total;
        document.getElementById('modalSequential').textContent = sequential.length;
        document.getElementById('modalResultBox').textContent = sequential.join('\n');
        modal?.classList.add('show');
      },

      closeModal: () => {
        document.getElementById('resultsModal')?.classList.remove('show');
      },

      copyFromModal: () => {
        const box = document.getElementById('modalResultBox');
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(box.textContent)
            .then(() => ExceptionHandler.toast('‚úì Copied!', 'success'))
            .catch(() => ExceptionHandler.toast('Copy failed', 'error'));
        }
      }
    };

    // NAVIGATION MANAGER
    const NavigationManager = {
      goTo: (pageName, btnElement) => {
        const pages = document.querySelectorAll('.page');
        const tabs = document.querySelectorAll('.nav-tab');

        pages.forEach(p => p.classList.remove('active'));
        tabs.forEach(t => t.classList.remove('active'));

        const page = document.getElementById(`page-${pageName}`);
        if (page) page.classList.add('active');
        if (btnElement) btnElement.classList.add('active');

        if (pageName === 'history') {
          HistoryManager.loadStats();
        }
      }
    };

    // HISTORY MANAGER
    const HistoryManager = {
      loadStats: async () => {
        try {
          const user = AuthManager.getUser();
          const access = await FirebaseManager.getAccessControl();
          const records = await FirebaseManager.getRecordsForUser(user, access);

          const yourRecords = records.filter(r => r.owner === user).length;
          const sharedRecords = records.filter(r => r.shared).length;

          document.getElementById('statYourRecords').textContent = yourRecords;
          document.getElementById('statSharedRecords').textContent = sharedRecords;
          document.getElementById('statTotalAccess').textContent = records.length;
        } catch (error) {
          console.error('Load stats error:', error);
        }
      },

           fetch: async () => {
        try {
          const user = AuthManager.getUser();
          const dateVal = document.getElementById('filterDate')?.value;
          const searchVal = document.getElementById('filterId')?.value?.trim().toUpperCase();
          const mode = document.getElementById('viewMode')?.value || 'my';
          const tbody = document.getElementById('historyBody');

          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;"><span class="spinner"></span></td></tr>';

          const access = await FirebaseManager.getAccessControl();
          const records = await FirebaseManager.getRecordsForUser(user, access);

          let filtered = records;
          if (mode === 'my') {
            filtered = records.filter(r => r.owner === user);
          } else if (mode === 'shared') {
            filtered = records.filter(r => r.shared);
          }

          // Filter by date
          if (dateVal) {
            filtered = filtered.filter(r => r.batch_date === dateVal);
          }

          // Filter by search term (ID or user)
          if (searchVal) {
            filtered = filtered.filter(r => 
              r.id?.includes(searchVal) || 
              r.owner?.toUpperCase().includes(searchVal)
            );
          }

          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-label);">No records found</td></tr>';
            return;
          }

          // Sort by date (newest first)
          filtered.sort((a, b) => {
            const dateA = a.uploaded_at?.toDate?.() || new Date(0);
            const dateB = b.uploaded_at?.toDate?.() || new Date(0);
            return dateB - dateA;
          });

          let html = '';
          filtered.forEach(r => {
            const uploadDate = r.uploaded_at?.toDate?.();
            const time = uploadDate?.toLocaleTimeString?.() || 'N/A';
            const date = r.batch_date || 'N/A';
            const ownerDisplay = r.shared ? `${r.owner} (shared)` : r.owner;
            
            html += `<tr>
              <td><b>${r.id}</b></td>
              <td>${ownerDisplay}</td>
              <td>${time}</td>
              <td>${date}</td>
              <td style="color:#10b981;">‚úì Sequential</td>
            </tr>`;
          });

          tbody.innerHTML = html;
        } catch (error) {
          console.error('Fetch error:', error);
          document.getElementById('historyBody').innerHTML = 
            '<tr><td colspan="5" style="text-align:center;color:#ef4444;">Error loading records</td></tr>';
        }
      }
    };

    // LOGIN PREVIEW - Show formatted ID as user types
    (() => {
      const idInput = document.getElementById('loginId');
      const preview = document.getElementById('loginPreview');

      if (idInput) {
        idInput.addEventListener('input', (e) => {
          const value = e.target.value.trim();
          const errorDiv = document.getElementById('loginError');
          errorDiv?.classList.remove('show');
          
          if (value) {
            const formatted = value.toUpperCase().replace(/\s/g, '');
            let fullId;
            
            if (/^\d{1,3}$/.test(formatted)) {
              fullId = `MINDA${formatted.padStart(3, '0')}`;
            } else if (/^MINDA\d{1,3}$/.test(formatted)) {
              const num = formatted.replace('MINDA', '').padStart(3, '0');
              fullId = `MINDA${num}`;
            } else {
              fullId = null;
            }
            
            if (fullId && /^MINDA\d{3}$/.test(fullId)) {
              preview.textContent = `‚úì Will login as: ${fullId}`;
              preview.classList.add('show');
            } else {
              preview.classList.remove('show');
            }
          } else {
            preview.classList.remove('show');
          }
        });

        // Allow Enter key to submit
        idInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            AuthManager.login();
          }
        });
      }

      // Admin password Enter key
      const adminPasswordInput = document.getElementById('adminPassword');
      if (adminPasswordInput) {
        adminPasswordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            AuthManager.verifyAdmin();
          }
        });
      }
    })();

    // HEARTBEAT - Keep user activity updated
    const Heartbeat = {
      intervalId: null,
      
      start: () => {
        // Update activity every 30 seconds
        Heartbeat.intervalId = setInterval(() => {
          const user = AuthManager.getUser();
          if (user) {
            FirebaseManager.updateUserActivity(user, true);
          }
        }, 30000);
      },
      
      stop: () => {
        if (Heartbeat.intervalId) {
          clearInterval(Heartbeat.intervalId);
          Heartbeat.intervalId = null;
        }
      }
    };

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      const user = AuthManager.getUser();
      if (!user) return;
      
      if (document.hidden) {
        // Page is hidden, but keep session
      } else {
        // Page is visible again, update activity
        FirebaseManager.updateUserActivity(user, true);
      }
    });

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      const user = AuthManager.getUser();
      if (user) {
        // Use sendBeacon for reliable delivery on page close
        const data = JSON.stringify({ user, action: 'offline' });
        // Note: This won't work directly with Firestore, but we're setting up the pattern
        // The heartbeat will handle cleanup when the user stops sending updates
      }
    });

    // CLEANUP - Remove stale active users (run by admin)
    const CleanupManager = {
      cleanStaleUsers: async () => {
        try {
          const db = FirebaseManager.getDb();
          const activityDoc = await db.collection('admin').doc('activity').get();
          
          if (!activityDoc.exists) return;
          
          const activeUsers = activityDoc.data().active_users || {};
          const now = Date.now();
          const staleThreshold = 2 * 60 * 1000; // 2 minutes
          
          const updates = {};
          let hasUpdates = false;
          
          for (const [userId, timestamp] of Object.entries(activeUsers)) {
            if (timestamp && timestamp.toDate) {
              const lastActive = timestamp.toDate().getTime();
              if (now - lastActive > staleThreshold) {
                updates[`active_users.${userId}`] = firebase.firestore.FieldValue.delete();
                hasUpdates = true;
              }
            }
          }
          
          if (hasUpdates) {
            await db.collection('admin').doc('activity').update(updates);
          }
        } catch (error) {
          console.error('Cleanup error:', error);
        }
      }
    };

    // INITIALIZATION
    (async () => {
      try {
        // Initialize Firebase first
        const initResult = await FirebaseManager.init();
        if (!initResult.success) {
          throw new Error('Failed to connect to database');
        }

        // Set default date filter
        const dateInput = document.getElementById('filterDate');
        if (dateInput) {
          dateInput.valueAsDate = new Date();
        }

        // Try to restore existing session
        const sessionRestored = await AuthManager.restoreSession();
        
        if (sessionRestored) {
          // Start heartbeat for active users
          Heartbeat.start();
          
          // If admin, run cleanup periodically
          if (AuthManager.isAdmin()) {
            setInterval(() => CleanupManager.cleanStaleUsers(), 60000);
            CleanupManager.cleanStaleUsers(); // Run immediately
          }
        }

      } catch (error) {
        console.error('Initialization error:', error);
        ExceptionHandler.toast('Failed to initialize application', 'error');
      }
    })();
  </script>

</body>
</html>
