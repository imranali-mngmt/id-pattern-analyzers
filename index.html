<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MindAid | Operations</title>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* --- EXACT UI MATCHING --- */
    :root {
      --bg-app: #f8fafc;
      --bg-panel: #ffffff;
      --text-main: #334155;
      --text-label: #94a3b8;
      --btn-color: #0f172a;
      --border-color: #e2e8f0;
      --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
    }

    * {
      box-sizing: border-box;
      outline: none;
    }

    body {
      font-family: var(--font-stack);
      background: var(--bg-app);
      color: var(--text-main);
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- 1. HEADER (Navigation) --- */
    .header {
      background: var(--bg-panel);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 40px;
      border-bottom: 1px solid var(--border-color);
    }

    .brand {
      font-weight: 800;
      font-size: 18px;
      color: #0f172a;
      letter-spacing: -0.5px;
    }

    .nav-tabs {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .nav-tab {
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .nav-tab.active {
      background: #f1f5f9;
      color: #0f172a;
      font-weight: 700;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .user-id {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
    }

    /* --- 2. MAIN LAYOUT --- */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 40px 20px;
      flex: 1;
      overflow-y: auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* --- 3. PROCESSOR VIEW --- */
    .split-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      height: calc(100vh - 160px);
    }

    .column {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .label-text {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    textarea {
      flex: 1;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      resize: none;
      color: #334155;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    textarea::placeholder {
      color: #cbd5e1;
    }

    textarea:focus {
      border-color: #cbd5e1;
      box-shadow: 0 0 0 3px rgba(226, 232, 240, 0.5);
    }

    #outputBox {
      border-left: 4px solid #0f172a;
      background: #ffffff;
    }

    .btn-execute {
      background: var(--btn-color);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      margin-top: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: opacity 0.2s;
    }

    .btn-execute:hover {
      opacity: 0.9;
    }

    .btn-execute:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .copy-link {
      text-align: right;
      font-size: 12px;
      color: #94a3b8;
      cursor: pointer;
      margin-top: 8px;
    }

    .copy-link:hover {
      color: var(--btn-color);
      text-decoration: underline;
    }

    /* --- 4. HISTORY VIEW --- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .stat-label {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: #0f172a;
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-sublabel {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
    }

    .chart-container {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #334155;
      background: white;
      cursor: pointer;
    }

    .chart-select:focus {
      border-color: #0f172a;
      outline: none;
    }

    #activityChart {
      max-height: 300px;
    }

    .table-wrapper {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .history-tools {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: flex-end;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .tool-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
    }

    .tool-label {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
    }

    .tool-input {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      text-align: left;
      padding: 15px;
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      font-weight: 700;
      border-bottom: 1px solid var(--border-color);
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid #f1f5f9;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      color: #334155;
    }

    /* --- LOGIN OVERLAY --- */
    #view-login {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      width: 320px;
      text-align: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    /* --- ERROR DISPLAY --- */
    .error-banner {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
    }

    .error-banner.show {
      display: block;
    }
  </style>
</head>

<body>

  <div id="view-login">
    <div class="login-box">
      <h3 style="margin:0 0 5px 0; color:#0f172a;">MindAid Access</h3>
      <p style="font-size:12px; color:#94a3b8; margin-bottom:25px;">Secure Environment</p>
      <input type="text" id="loginId" class="tool-input" style="width:100%; text-align:center; margin-bottom:15px;"
        placeholder="MindA ID (e.g. minda079)">
      <button class="btn-execute" style="margin-top:0" onclick="doLogin()">Login</button>
      <div id="loginError" style="color:#ef4444; font-size:12px; margin-top:10px; display:none;"></div>
    </div>
  </div>

  <div id="view-app" style="display:none; height:100vh; flex-direction:column;">

    <div class="header">
      <div class="brand">MindAid</div>
      <div class="nav-tabs">
        <div class="nav-tab active" onclick="navigateTo('processor', this)">Processor</div>
        <div class="nav-tab" onclick="navigateTo('history', this)">My History</div>
      </div>
      <div id="userBadge" class="user-id"></div>
    </div>

    <div class="container">
      <div id="errorBanner" class="error-banner"></div>

      <div id="page-processor" class="page active">
        <div class="split-grid">

          <div class="column">
            <div class="label-text">Input Stream</div>
            <textarea id="inputData" placeholder="Paste data here..."></textarea>
            <button id="executeBtn" class="btn-execute" onclick="runProcessor()">EXECUTE</button>
          </div>

          <div class="column">
            <div class="label-text" style="color:#64748b">Result (Auto-Uploaded)</div>
            <textarea id="outputBox" readonly></textarea>
            <div class="copy-link" onclick="copyOutput()">Copy to Clipboard</div>
          </div>

        </div>
      </div>

      <div id="page-history" class="page">

        <!-- Stats Overview Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Today</div>
            <div class="stat-value" id="statToday">0</div>
            <div class="stat-sublabel">IDs Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Yesterday</div>
            <div class="stat-value" id="statYesterday">0</div>
            <div class="stat-sublabel">IDs Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">This Week</div>
            <div class="stat-value" id="statWeek">0</div>
            <div class="stat-sublabel">IDs Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total</div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-sublabel">All Time</div>
          </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-container">
          <div class="chart-header">
            <span class="label-text">Weekly Activity</span>
            <select id="chartPeriod" class="chart-select" onchange="updateChartPeriod()">
              <option value="7">Last 7 Days</option>
              <option value="14">Last 14 Days</option>
              <option value="30">Last 30 Days</option>
            </select>
          </div>
          <canvas id="activityChart"></canvas>
        </div>

        <!-- Search & Table Section -->
        <div class="history-tools">
          <div class="tool-group">
            <span class="tool-label">Filter Date</span>
            <input type="date" id="filterDate" class="tool-input">
          </div>
          <div class="tool-group">
            <span class="tool-label">Search ID</span>
            <input type="text" id="filterId" class="tool-input" placeholder="Paste 11-digit ID">
          </div>
          <button class="btn-execute" style="width:auto; margin:0; padding:10px 25px;"
            onclick="fetchHistory()">Search</button>
        </div>

        <div class="table-wrapper">
          <table id="historyTable">
            <thead>
              <tr>
                <th>ID Sequence</th>
                <th>Time Logged</th>
                <th>Batch Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // --- EXCEPTION HANDLER UTILITY ---
    const ExceptionHandler = {
      log: (context, error) => {
        console.error(`[${context}]`, error);
        const timestamp = new Date().toISOString();
        const logEntry = { context, error: error.message || error, timestamp };

        try {
          const logs = JSON.parse(localStorage.getItem('errorLogs') || '[]');
          logs.push(logEntry);
          if (logs.length > 100) logs.shift();
          localStorage.setItem('errorLogs', JSON.stringify(logs));
        } catch (e) {
          console.error('Failed to store error log', e);
        }
      },

      show: (message, duration = 3000) => {
        const banner = document.getElementById('errorBanner');
        if (banner) {
          banner.textContent = message;
          banner.classList.add('show');
          setTimeout(() => banner.classList.remove('show'), duration);
        }
      },

      toast: (message, type = 'error') => {
        const colors = {
          error: '#ef4444',
          warning: '#f59e0b',
          success: '#10b981',
          info: '#0f172a'
        };

        try {
          Toastify({
            text: message,
            duration: 3000,
            style: { background: colors[type] || colors.error, borderRadius: "4px" }
          }).showToast();
        } catch (e) {
          alert(message);
        }
      }
    };

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAAM8jlY-zKAsTNu3BKmrLtz0rb_fG-P24",
      authDomain: "imranali-mngmt-e464f.firebaseapp.com",
      projectId: "imranali-mngmt-e464f",
      storageBucket: "imranali-mngmt-e464f.firebasestorage.app",
      messagingSenderId: "1030605656898",
      appId: "1:1030605656898:web:3825d797b521c9c90a2edb"
    };

    let db = null;
    let currentUser = null;
    let activityChart = null;
    let chartData = { labels: [], data: [] };

    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
    } catch (e) {
      ExceptionHandler.log('Firebase Init', e);
      ExceptionHandler.show('Firebase initialization failed. Please refresh the page.');
    }

    // --- LOGIN FUNCTION ---
    function doLogin(val) {
      try {
        val = val || document.getElementById('loginId').value.trim();

        if (!val) {
          throw new Error('Please enter a MindA ID');
        }

        if (!val.toLowerCase().startsWith("minda")) {
          throw new Error('Invalid ID format. Must start with "minda"');
        }

        currentUser = val;
        localStorage.setItem('mindAidUser', val);

        document.getElementById('userBadge').innerText = val;
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-app').style.display = 'flex';

        loadStats();
        fetchHistory();

      } catch (e) {
        ExceptionHandler.log('Login', e);
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
          errorDiv.textContent = e.message;
          errorDiv.style.display = 'block';
        }
      }
    }

    // --- NAVIGATION FUNCTION ---
    function navigateTo(page, btn) {
      try {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));

        const pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.classList.add('active');
        if (btn) btn.classList.add('active');

        if (page === 'history') {
          loadStats();
        }

      } catch (e) {
        ExceptionHandler.log('Navigation', e);
        ExceptionHandler.toast('Navigation failed', 'error');
      }
    }

    // --- PROCESSOR FUNCTION ---
    async function runProcessor() {
      const executeBtn = document.getElementById('executeBtn');

      try {
        if (!db) {
          throw new Error('Database not initialized');
        }

        const input = document.getElementById('inputData').value;
        const outBox = document.getElementById('outputBox');

        if (!input || input.trim() === '') {
          throw new Error('Input field is empty');
        }

        if (executeBtn) executeBtn.disabled = true;

        const matches = input.match(/\b\d{11}\b/g);

        if (!matches || matches.length === 0) {
          throw new Error('No 11-digit IDs found in input');
        }

        const unique = [...new Set(matches)].map(s => {
          try {
            return { str: s, val: BigInt(s) };
          } catch (e) {
            ExceptionHandler.log('BigInt Conversion', e);
            return null;
          }
        }).filter(Boolean);

        if (unique.length === 0) {
          throw new Error('Failed to process IDs');
        }

        unique.sort((a, b) => (a.val < b.val) ? -1 : ((a.val > b.val) ? 1 : 0));

        const sequenceIds = [];
        for (let i = 0; i < unique.length; i++) {
          const curr = unique[i].val;
          let isSeq = false;

          try {
            if (i > 0 && curr === unique[i - 1].val + 1n) isSeq = true;
            if (i < unique.length - 1 && curr === unique[i + 1].val - 1n) isSeq = true;
          } catch (e) {
            ExceptionHandler.log('Sequence Check', e);
            continue;
          }

          if (isSeq) sequenceIds.push(unique[i].str);
        }

        if (sequenceIds.length === 0) {
          ExceptionHandler.toast("No sequential IDs found", 'warning');
          return;
        }

        outBox.value = sequenceIds.join('\n');
        document.getElementById('inputData').value = "";

        ExceptionHandler.toast(`✓ Found ${sequenceIds.length} Sequential ID${sequenceIds.length > 1 ? 's' : ''}`, 'success');

        await uploadToDatabase(sequenceIds);

        setTimeout(() => {
          ExceptionHandler.toast("Uploaded to Database", 'info');
        }, 1500);

      } catch (e) {
        ExceptionHandler.log('Processor Run', e);
        ExceptionHandler.toast(e.message || 'Processing failed', 'error');
      } finally {
        if (executeBtn) executeBtn.disabled = false;
      }
    }

    // --- UPLOAD FUNCTION ---
    async function uploadToDatabase(ids) {
      try {
        if (!db) {
          throw new Error('Database connection unavailable');
        }

        if (!currentUser) {
          throw new Error('User not authenticated');
        }

        if (!ids || ids.length === 0) {
          throw new Error('No IDs to upload');
        }

        const batch = db.batch();
        const userRef = db.collection('users').doc(currentUser);
        const today = new Date().toISOString().split('T')[0];

        ids.forEach(id => {
          try {
            const ref = userRef.collection('records').doc(id);
            batch.set(ref, {
              id: id,
              parsed_by: currentUser,
              uploaded_at: firebase.firestore.FieldValue.serverTimestamp(),
              batch_date: today
            });
          } catch (e) {
            ExceptionHandler.log(`Upload ID ${id}`, e);
          }
        });

        await batch.commit();

      } catch (e) {
        ExceptionHandler.log('Upload Batch', e);
        throw new Error('Database upload failed: ' + e.message);
      }
    }

    // --- COPY FUNCTION ---
    function copyOutput() {
      try {
        const t = document.getElementById('outputBox');

        if (!t || !t.value) {
          throw new Error('Nothing to copy');
        }

        t.select();

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(t.value)
            .then(() => ExceptionHandler.toast("Copied!", 'success'))
            .catch(e => {
              ExceptionHandler.log('Clipboard API', e);
              document.execCommand('copy');
              ExceptionHandler.toast("Copied!", 'success');
            });
        } else {
          document.execCommand('copy');
          ExceptionHandler.toast("Copied!", 'success');
        }

      } catch (e) {
        ExceptionHandler.log('Copy', e);
        ExceptionHandler.toast('Copy failed', 'error');
      }
    }

    // --- FETCH HISTORY FUNCTION ---
    async function fetchHistory() {
      try {
        if (!db) {
          throw new Error('Database not initialized');
        }

        const dateVal = document.getElementById('filterDate').value;
        const idVal = document.getElementById('filterId').value.trim();
        const tbody = document.getElementById('historyBody');

        if (!tbody) {
          throw new Error('History table not found');
        }

        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8; padding:20px;">Loading...</td></tr>';

        let query = db.collection('users').doc(currentUser).collection('records');

        if (idVal.length > 0) {
          if (!/^\d{11}$/.test(idVal)) {
            throw new Error('Invalid ID format. Must be 11 digits');
          }

          const doc = await query.doc(idVal).get();

          if (doc.exists) {
            const d = doc.data();
            const time = d.uploaded_at ? d.uploaded_at.toDate().toLocaleString() : "Unknown";
            const date = d.batch_date || "Unknown";
            tbody.innerHTML = `<tr><td><b>${d.id}</b></td><td>${time}</td><td>${date}</td><td style="color:#10b981">✓ Found</td></tr>`;
          } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ef4444; padding:20px;">ID Not Found</td></tr>';
          }
          return;
        }

        if (!dateVal) {
          throw new Error('Please select a date');
        }

        try {
          query = query.where("batch_date", "==", dateVal).orderBy("uploaded_at", "desc").limit(100);
          const snap = await query.get();

          if (snap.empty) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8; padding:20px;">No records for this date.</td></tr>';
            return;
          }

          let html = '';
          snap.forEach(doc => {
            try {
              const d = doc.data();
              const time = d.uploaded_at ? d.uploaded_at.toDate().toLocaleTimeString() : "";
              const date = d.batch_date || "";
              html += `<tr><td><b>${d.id}</b></td><td>${time}</td><td>${date}</td><td style="color:#64748b">Stored</td></tr>`;
            } catch (e) {
              ExceptionHandler.log('History Row', e);
            }
          });

          tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center; color:#94a3b8;">No data</td></tr>';

        } catch (indexError) {
          // Fallback: If index doesn't exist, fetch without ordering
          ExceptionHandler.log('Index Missing', indexError);
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#f59e0b; padding:20px;">⚠ Creating database index... Please click the link in console and wait 5-10 minutes.</td></tr>';

          // Try without orderBy as fallback
          query = db.collection('users').doc(currentUser).collection('records').where("batch_date", "==", dateVal).limit(100);
          const snap = await query.get();

          if (!snap.empty) {
            const docs = [];
            snap.forEach(doc => docs.push(doc));
            docs.sort((a, b) => {
              const timeA = a.data().uploaded_at?.toDate() || new Date(0);
              const timeB = b.data().uploaded_at?.toDate() || new Date(0);
              return timeB - timeA;
            });

            let html = '';
            docs.forEach(doc => {
              try {
                const d = doc.data();
                const time = d.uploaded_at ? d.uploaded_at.toDate().toLocaleTimeString() : "";
                const date = d.batch_date || "";
                html += `<tr><td><b>${d.id}</b></td><td>${time}</td><td>${date}</td><td style="color:#64748b">Stored</td></tr>`;
              } catch (e) {
                ExceptionHandler.log('History Row', e);
              }
            });

            tbody.innerHTML = html;
          }
        }

      } catch (e) {
        ExceptionHandler.log('History Fetch', e);
        const tbody = document.getElementById('historyBody');
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#ef4444; padding:20px;">${e.message}</td></tr>`;
        }
        ExceptionHandler.toast(e.message, 'error');
      }
    }

    // --- LOAD STATS FUNCTION ---
    async function loadStats() {
      try {
        if (!db || !currentUser) return;

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        const weekAgoStr = weekAgo.toISOString().split('T')[0];

        const userRef = db.collection('users').doc(currentUser).collection('records');

        const todaySnap = await userRef.where('batch_date', '==', todayStr).get();
        document.getElementById('statToday').textContent = todaySnap.size;

        const yesterdaySnap = await userRef.where('batch_date', '==', yesterdayStr).get();
        document.getElementById('statYesterday').textContent = yesterdaySnap.size;

        const weekSnap = await userRef.where('batch_date', '>=', weekAgoStr).get();
        document.getElementById('statWeek').textContent = weekSnap.size;

        const totalSnap = await userRef.limit(1000).get();
        document.getElementById('statTotal').textContent = totalSnap.size;

        await loadChartData();

      } catch (e) {
        ExceptionHandler.log('Load Stats', e);
      }
    }

    // --- LOAD CHART DATA FUNCTION ---
    async function loadChartData() {
      try {
        const days = parseInt(document.getElementById('chartPeriod').value) || 7;
        const data = [];
        const labels = [];

        for (let i = days - 1; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];

          const snap = await db.collection('users')
            .doc(currentUser)
            .collection('records')
            .where('batch_date', '==', dateStr)
            .get();

          data.push(snap.size);
          labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        }

        chartData = { labels, data };
        updateChart();

      } catch (e) {
        ExceptionHandler.log('Load Chart Data', e);
      }
    }

    // --- UPDATE CHART FUNCTION ---
    function updateChart() {
      try {
        const canvas = document.getElementById('activityChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        if (activityChart) {
          activityChart.destroy();
        }

        activityChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: chartData.labels || [],
            datasets: [{
              label: 'IDs Found',
              data: chartData.data || [],
              backgroundColor: 'rgba(15, 23, 42, 0.8)',
              borderColor: '#0f172a',
              borderWidth: 2,
              borderRadius: 6,
              hoverBackgroundColor: '#0f172a'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: '#0f172a',
                padding: 12,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 14 },
                borderColor: '#334155',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                  color: '#64748b',
                  font: { size: 11, weight: '600' }
                },
                grid: {
                  color: '#f1f5f9',
                  drawBorder: false
                }
              },
              x: {
                ticks: {
                  color: '#64748b',
                  font: { size: 11, weight: '600' }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });

      } catch (e) {
        ExceptionHandler.log('Update Chart', e);
      }
    }

    // --- UPDATE CHART PERIOD FUNCTION ---
    function updateChartPeriod() {
      loadChartData();
    }

    // --- INITIALIZATION ---
    function initApp() {
      try {
        const saved = localStorage.getItem('mindAidUser');
        if (saved) {
          doLogin(saved);
        }

        const dateInput = document.getElementById('filterDate');
        if (dateInput) {
          dateInput.valueAsDate = new Date();
        }

        window.addEventListener('error', (e) => {
          ExceptionHandler.log('Global Error', e.error || e.message);
        });

        window.addEventListener('unhandledrejection', (e) => {
          ExceptionHandler.log('Unhandled Promise', e.reason);
        });

      } catch (e) {
        ExceptionHandler.log('App Init', e);
        ExceptionHandler.show('Application initialization failed');
      }
    }

    window.onload = initApp;
    
  </script>

</body>

</html>